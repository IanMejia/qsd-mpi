# Makefile for QSD code.

QSD_DIR = .
FFTW3DIR = /usr/cta/unsupported/petccm/lib/fftw-3.2.2
CXX = g++
INCLUDE = /opt/intel/11.1/mkl/include
FLAGS = -g -O -Wno-deprecated  -I$(INCLUDE)
FC       = ifort  -c
DFLAGS   =  -D__INTEL -D__LAPACK -D__FFTW3
FCFLAGS =  -O2 -ftz -IPF-fp-relaxed  -heap-arrays 64 -I$(INCLUDE) 
INC = $(QSD_DIR)/include
SRC = $(QSD_DIR)/src

LOADLIBES = -lm
FLDFLAGS = -L/opt/intel/11.1/lib/intel64/ -lifcore
LDFLAGS = -L$(MKLPATH) -lmkl_lapack -lmkl_solver_ilp64_sequential -Wl,--start-group -lmkl_intel_ilp64 -lmkl_sequential -lmkl_core -Wl,--end-group -lpthread 
FFTFLAGS = -L$(FFTW3DIR)/lib  -lfftw3
CXXFLAGS = -I$(INC) -I$(HOME)/include  -I$(FFTW3DIR)/include  $(FLAGS)
CPPFLAGS = -L$(MKLPATH) -lmkl_lapack

COMPILE = $(CXX) -c  $(CXXFLAGS)
FCOMPILE  = $(FC) $(FCFLAGS) $(DFLAGS)
LINK = icpc $(CXXFLAGS) $(LDFLAGS) $(FFTFLAGS) $(FLDFLAGS)

RAN_OBJ =  Random.o Normal.o Uniform.o RNG.o ACG.o MLCG.o CmplxRan.o
RAN_HEAD = $(INC)/Random.h $(INC)/Normal.h $(INC)/Uniform.h $(INC)/RNG.h $(INC)/ACG.h $(INC)/MLCG.h $(INC)/CmplxRan.h

OBJ1 =  Operator.o PrimOp.o State.o Complex.o 
HEAD1 = $(INC)/Operator.h $(INC)/PrimOp.h $(INC)/State.h $(INC)/Complex.h $(INC)/Mesh.h
OBJ2 = FieldOp.o SpinOp.o AtomOp.o
OBJ3 = Traject.o $(RAN_OBJ)
OBJ4 = mesh.o coeff.o poisson.o 
OBJ5 = Mesh.o Coeff.o Epot.o Poisson.o
OBJ = $(OBJ1) $(OBJ2) $(OBJ3) $(OBJ4) $(OBJ5)
#-------------------------------------------------------------------
# Add driver routines here.

ALL = onespin spins simple moving sums testprog template lineob damped qcascade sechar qd 

qd: qd.cc $(OBJ)
	$(LINK) -o qd qd.cc $(OBJ)  $(LOADLIBES)

##qdf: qdf.f90 $(OBJ)
##	$(LINK) -o qdf qdf.f90 $(OBJ) $(LOADLIBES) 

onespin: onespin.cc $(OBJ)
	$(LINK) -o onespin onespin.cc $(OBJ) $(LOADLIBES)

spins: spins.cc $(OBJ)
	$(LINK) -o spins spins.cc $(OBJ) $(LOADLIBES)

simple: simple.cc $(OBJ)
	$(LINK) -o simple simple.cc $(OBJ) $(LOADLIBES)

lineob: lineob.cc $(OBJ)
	$(LINK) -o lineob lineob.cc $(OBJ) $(LOADLIBES)

qcascade: qcascade.cc $(OBJ)
	$(LINK) -o qcascade qcascade.cc $(OBJ) $(LOADLIBES)

sechar: sechar.cc $(OBJ)
	$(LINK) -o sechar sechar.cc $(OBJ) $(LOADLIBES)

damped: damped.cc $(OBJ)
	$(LINK) -o damped damped.cc $(OBJ) $(LOADLIBES)

moving: moving.cc $(OBJ)
	$(LINK) -o moving moving.cc $(OBJ) $(LOADLIBES)

sums: sums.cc $(OBJ)
	$(LINK) -o sums sums.cc $(OBJ) $(LOADLIBES)

testprog: testprog.cc $(OBJ)
	$(LINK) -o testprog testprog.cc $(OBJ) $(LOADLIBES)

template: template.cc $(OBJ)
	$(LINK) -o template template.cc $(OBJ) $(LOADLIBES)

#-------------------------------------------------------------------

all: $(ALL)

cleanexe:
	rm $(ALL)

cleanrand:
	rm $(RAN_OBJ)

clean:
	rm *.o

Traject.o: $(SRC)/Traject.cc $(INC)/Traject.h $(HEAD1) $(RAN_HEAD)
	$(COMPILE) $(SRC)/Traject.cc

State.o: $(SRC)/State.cc $(HEAD1)
	$(COMPILE) $(SRC)/State.cc

Operator.o: $(SRC)/Operator.cc $(HEAD1)
	$(COMPILE) $(SRC)/Operator.cc

PrimOp.o: $(SRC)/PrimOp.cc $(HEAD1)
	$(COMPILE) $(SRC)/PrimOp.cc

FieldOp.o: $(SRC)/FieldOp.cc $(INC)/FieldOp.h $(HEAD1)
	$(COMPILE) $(SRC)/FieldOp.cc

SpinOp.o: $(SRC)/SpinOp.cc $(INC)/SpinOp.h $(HEAD1)
	$(COMPILE) $(SRC)/SpinOp.cc

AtomOp.o: $(SRC)/AtomOp.cc $(INC)/AtomOp.h $(HEAD1)
	$(COMPILE) $(SRC)/AtomOp.cc

Complex.o: $(SRC)/Complex.cc $(INC)/Complex.h
	$(COMPILE) $(SRC)/Complex.cc

Mesh.o: $(SRC)/Mesh.cc $(INC)/Mesh.h
	$(COMPILE) $(SRC)/Mesh.cc

Epot.o: $(SRC)/Epot.cc $(INC)/Epot.h
	$(COMPILE) $(SRC)/Epot.cc

Coeff.o: $(SRC)/Coeff.cc 
	$(COMPILE) $(SRC)/Coeff.cc

Poisson.o: $(SRC)/Poisson.cc
	$(COMPILE) $(SRC)/Poisson.cc

Random.o: $(SRC)/Random.cc $(RAN_HEAD)
	$(COMPILE) $(SRC)/Random.cc

Normal.o: $(SRC)/Normal.cc $(RAN_HEAD)
	$(COMPILE) $(SRC)/Normal.cc

Uniform.o: $(SRC)/Uniform.cc $(RAN_HEAD)
	$(COMPILE) $(SRC)/Uniform.cc

RNG.o: $(SRC)/RNG.cc $(RAN_HEAD)
	$(COMPILE) $(SRC)/RNG.cc

ACG.o: $(SRC)/ACG.cc $(RAN_HEAD)
	$(COMPILE) $(SRC)/ACG.cc

MLCG.o: $(SRC)/MLCG.cc $(RAN_HEAD)
	$(COMPILE) $(SRC)/MLCG.cc

CmplxRan.o: $(SRC)/CmplxRan.cc $(RAN_HEAD) $(INC)/Complex.h
	$(COMPILE) $(SRC)/CmplxRan.cc

coeff.o: $(SRC)/coeff.f90
	$(FCOMPILE) $(SRC)/coeff.f90

fftw3.o: $(SRC)/fftw3.f90
	$(FCOMPILE) $(SRC)/fftw3.f90

cf.o: $(SRC)/cf.f90
	$(FCOMPILE) $(SRC)/cf.f90

poisson.o: $(SRC)/poisson.f90
	$(FCOMPILE) $(SRC)/poisson.f90

mesh.o : $(SRC)/mesh.f90
	$(FCOMPILE) $(SRC)/mesh.f90
